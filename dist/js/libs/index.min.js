"use strict";var isWebSocket=function(e){return e&&2===e.CLOSING},isGlobalWebSocket=function(){return"undefined"!=typeof WebSocket&&isWebSocket(WebSocket)},getDefaultOptions=function(){return{constructor:isGlobalWebSocket()?WebSocket:null,maxReconnectionDelay:1e4,minReconnectionDelay:1500,reconnectionDelayGrowFactor:1.3,connectionTimeout:4e3,maxRetries:1/0,debug:!1}},bypassProperty=function(e,n,o){Object.defineProperty(n,o,{get:function(){return e[o]},set:function(n){e[o]=n},enumerable:!0,configurable:!0})},initReconnectionDelay=function(e){return e.minReconnectionDelay+Math.random()*e.minReconnectionDelay},updateReconnectionDelay=function(e,n){var o=n*e.reconnectionDelayGrowFactor;return o>e.maxReconnectionDelay?e.maxReconnectionDelay:o},LEVEL_0_EVENTS=["onopen","onclose","onmessage","onerror"],reassignEventListeners=function(e,n,o){Object.keys(o).forEach(function(n){o[n].forEach(function(o){var t=o[0],r=o[1];e.addEventListener(n,t,r)})}),n&&LEVEL_0_EVENTS.forEach(function(o){e[o]=n[o]})},ReconnectingWebsocket=function(e,n,o){var t=this;void 0===o&&(o={});var r,c,i=0,s=0,a=!0,u=null,l={};if(!(this instanceof ReconnectingWebsocket))throw new TypeError("Failed to construct 'ReconnectingWebSocket': Please use the 'new' operator");var f=getDefaultOptions();if(Object.keys(f).filter(function(e){return o.hasOwnProperty(e)}).forEach(function(e){return f[e]=o[e]}),!isWebSocket(f.constructor))throw new TypeError("Invalid WebSocket constructor. Set `options.constructor`");var d=f.debug?function(){for(var e=[],n=0;n<arguments.length;n++)e[n]=arguments[n];return console.log.apply(console,["RWS:"].concat(e))}:function(){},y=function(e,n){return setTimeout(function(){var o=new Error(n);o.code=e,Array.isArray(l.error)&&l.error.forEach(function(e){return(0,e[0])(o)}),r.onerror&&r.onerror(o)},0)},v=function(){d("handleClose",{shouldRetry:a}),d("retries count:",++s),s>f.maxRetries?y("EHOSTDOWN","Too many failed connection attempts"):(i=i?updateReconnectionDelay(f,i):initReconnectionDelay(f),d("handleClose - reconnectDelay:",i),a&&setTimeout(E,i))},E=function(){if(a){d("connect");var o=r,E="function"==typeof e?e():e;r=new f.constructor(E,n),c=setTimeout(function(){d("timeout"),r.close(),y("ETIMEDOUT","Connection timeout")},f.connectionTimeout),d("bypass properties");for(var m in r)["addEventListener","removeEventListener","close","send"].indexOf(m)<0&&bypassProperty(r,t,m);r.addEventListener("open",function(){clearTimeout(c),d("open"),i=initReconnectionDelay(f),d("reconnectDelay:",i),s=0}),r.addEventListener("close",v),reassignEventListeners(r,o,l),r.onclose=r.onclose||u,u=null}};d("init"),E(),this.close=function(e,n,o){void 0===e&&(e=1e3),void 0===n&&(n="");var t=void 0===o?{}:o,c=t.keepClosed,y=void 0!==c&&c,E=t.fastClose,m=void 0===E||E,p=t.delay,b=void 0===p?0:p;if(d("close - params:",{reason:n,keepClosed:y,fastClose:m,delay:b,retriesCount:s,maxRetries:f.maxRetries}),a=!y&&s<=f.maxRetries,b&&(i=b),r.close(e,n),m){var h={code:e,reason:n,wasClean:!0};v(),r.removeEventListener("close",v),Array.isArray(l.close)&&l.close.forEach(function(e){var n=e[0],o=e[1];n(h),r.removeEventListener("close",n,o)}),r.onclose&&(u=r.onclose,r.onclose(h),r.onclose=null)}},this.send=function(e){r.send(e)},this.addEventListener=function(e,n,o){Array.isArray(l[e])?l[e].some(function(e){return e[0]===n})||l[e].push([n,o]):l[e]=[[n,o]],r.addEventListener(e,n,o)},this.removeEventListener=function(e,n,o){Array.isArray(l[e])&&(l[e]=l[e].filter(function(e){return e[0]!==n})),r.removeEventListener(e,n,o)}};module.exports=ReconnectingWebsocket;